<!--
  JBoss, Home of Professional Open Source
  Copyright 2013, Red Hat, Inc. and individual contributors
  by the @authors tag. See the copyright.txt in the distribution for a
  full listing of individual contributors.

  This is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation; either version 2.1 of
  the License, or (at your option) any later version.

  This software is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public
  License along with this software; if not, write to the Free
  Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
  02110-1301 USA, or see the FSF site: http://www.fsf.org.
  -->

<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html" xmlns:r="http://richfaces.org/rich"
    xmlns:richx="http://richfaces.org/richx">

    <r:dataGrid value="#{model.selectedEvent.shelf.images}" var="image" columns="5">
        <r:commandLink actionListener="#{controller.showImage(image)}" render="mainArea, treePanel">
            <r:mediaOutput id="img" element="img" createContent="#{imageLoader.paintImage}" style="border : 1px solid #FFFFFF;"
                mimeType="image/jpeg" value="#{fileManager.transformPath(image.fullPath, '_small200')}">
            </r:mediaOutput>
        </r:commandLink>
    </r:dataGrid>

    <r:outputPanel rendered="#{not userBean.loggedInGPlus}">
        <h:outputText value="This event has #{fn:length(model.selectedEvent.googlePlusAlbumIds)} albums on Google+, " />
        <r:commandLink value="#{messages['menu.login']}" render="loginPanel" actionListener="#{userBean.reset()}"
            oncomplete="#{r:component('loginPanel')}.show();" />
        <h:outputText value=" to see them." />
    </r:outputPanel>

    <r:outputPanel id="photoPanel" rendered="#{userBean.loggedInGPlus}">
        <r:dataGrid rendered="#{fn:length(eventAlbumsHelper.eventPhotos) > 0}" value="#{eventAlbumsHelper.eventPhotos}"
            var="photo" columns="5" id="photos">
            <r:outputPanel>
                <r:commandLink execute="@this" actionListener="#{controller.showGPlusImage(photo.getString('id'))}"
                    render="mainArea">
                    <h:graphicImage id="img" url="#{photo.getString('thumbUrl')}" style="max-width: 180px; max-height: 180px"
                        styleClass="album-cover-image" />
                    <r:param assignTo="#{googlePlusAlbumCache.currentAlbumId}" value="#{photo.getString('fullAlbumId')}" />
                </r:commandLink>
            </r:outputPanel>
        </r:dataGrid>
    </r:outputPanel>

    <h:outputText value="No photos available."
        rendered="#{fn:length(model.selectedEvent.remoteAlbumIds) + fn:length(model.selectedEvent.shelf.albums) == 0}" />

    <!-- JavaScript -->
    <r:jsFunction name="initHelper" actionListener="#{eventAlbumsHelper.init()}" execute="@this" render="gImagePoll, photoPanel" />

    <r:jsFunction name="processAlbum" execute="@this" oncomplete="loadNextAlbum()">
        <r:param assignTo="#{googlePlusAlbumCache.albumAndImages}" name="response" />
    </r:jsFunction>

    <r:jsFunction name="loadNextAlbum" actionListener="#{eventAlbumsHelper.loadNext}" execute="@this"
        render="photoPanel, gImagePoll" />

    <h:outputScript>
        $(document).ready(function() {
                    initHelper();
                });
    </h:outputScript>

    <r:poll interval="500" id="gImagePoll" enabled="#{eventAlbumsHelper.pollEnabled}"
        ontimer="if(#{eventAlbumsHelper.nextId != '0'}){G.getAlbumAndPhotos('#{eventAlbumsHelper.nextId}', processAlbum); enablePoll(false);}"
        execute="@this" render="@this" />

    <r:jsFunction name="enablePoll" execute="@this">
        <r:param name="enabled" assignTo="#{eventAlbumsHelper.pollEnabled}" />
    </r:jsFunction>
</ui:composition>